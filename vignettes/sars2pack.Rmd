---
title: "sars2pack: packaging of C. Morefield code on COVID-19 epidemic modeling"
author: "Sean Davis <seandavi@gmail.com> and Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{sars2pack: Access and use public COVID-19 datasets}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---

```{r setup,echo=FALSE}
suppressMessages({
suppressPackageStartupMessages({
library(BiocStyle)
library(sars2pack)
library(dplyr)
library(tibble)
library(lubridate)
})
})
```

# Motivation

The COVID-19 pandemic is ongoing. The situation on the ground is
changing daily as captured by data reported around the world. The
[sars2pack] package aims to:

- Provide timely, computable, easily accessible data for research,
   policy-making, and educational purposes.
- Promote easy computational experimentation with COVID-19 data
- Serve as a source of documentation and education for available
   COVID-19 analysis and visualization approaches.
- House recipes for regularly updated data products such as
   spreadsheets and maps for use by non-R-savvy data consumers.
- Collect interesting data stories along with code as data science
   training resources for the many biomedical researchers who cannot
   currently perform experiments

# Quick start

## Installation

```{r}
BiocManager::install('seandavi/sars2pack')
```

[sars2pack]: https://github.com/seandavi/sars2pack
[New York Times]: https://github.com/nytimes/covid-19-data
[JHU]: https://github.com/CSSEGISandData/COVID-19/tree/master/csse_covid_19_data/
[USAFacts]:  https://usafacts.org/visualizations/coronavirus-covid-19-spread-map/
[pull request]: https://github.com/seandavi/sars2pack/compare
[issue]: https://github.com/seandavi/sars2pack/issues/new

## COVID-19 resources in this package

The COVID-19 data in this package are, right now, focused toward 
time-series descriptions of confirmed cases, deaths, testing, and
recovered cases. **There is no requirement that this remain the case**.
Contributions of additional data resources or simple accessor functions
will only add to our abilities to use data science and modeling
to understand COVID-19.

*Request for help*: I would be more than happy to accept help with 
defining new data resources. Consider a [pull request] (or an [issue] for
non-programmer types). 

### Epidemic time-series data

- [JHU] : global deaths, confirmed cases, and recovered time series
  data; *does not include fine-level United States data*. See
  `jhu_data()`.
- [New York Times] : United states state and county level deaths,
  confirmed cases time series. See `nytimes_county_data()` and
  `nytimes_state_data`.
- [USAFacts] : Alternative United states state and county level deaths
  and confirmed cases time series

## Additional resources described in this vignette



- 


# COVID-19 data resources

This section briefly introduces how to access the data
resources in this package. Note that many of the functions
below **require a network connection** to get updated data.

## Epidemic time series data

Accessing the time series datasets follow a similar pattern. 

1. Fetch a tidy `tbl_df` using a function such as `jhu_data()`
2. The columns `date` (of type `date`) and `count` of type `numeric`
   columns are standard.
3. Additional columns describe locations, subsets of data (such as
   `confirmed`, `deaths`, `recovered`).

Regardless of the original format of the data, the `sars2pack`
datasets are presented as [tidy data] to facilitate `dplyr`, `ggplot`,
and other fluid analysis approaches to apply directly.

[tidy data]: https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html

### JHU Dataset

```{r jhu_access}
jhu = jhu_data()
class(jhu)
dim(jhu)
```

Column names include:

```{r jhu_cols}
colnames(jhu)
```

And a very small subset of the data. 

```{r jhu_example}
head(jhu,3)
```


### USAFacts Dataset



```{r usa_facts_access}
usa_facts = usa_facts_data()
class(usa_facts)
dim(usa_facts)
```

Column names include:

```{r usa_facts_cols}
colnames(usa_facts)
```

And a very small subset of the data. 

```{r usa_facts_example}
head(usa_facts,3)
```


### NYTimes datasets



```{r nytimes_state_access}
nytimes_state = nytimes_state_data()
class(nytimes_state)
dim(nytimes_state)
```

Column names include:

```{r nytimes_state_cols}
colnames(nytimes_state)
```

And a very small subset of the data. 

```{r nytimes_state_example}
head(nytimes_state,3)
```


```{r nytimes_county_access}
nytimes_county = nytimes_county_data()
class(nytimes_county)
dim(nytimes_county)
colnames(nytimes_county)
```


Looking at the raw data seems important to get a clear sense
of the modeling challenge.
```{r doser,fig.height=7}
get_series = function(province="", country, dataset=sars2pack::mar19df) {
  ans = dataset %>% filter(ProvinceState==province & CountryRegion==country)
  ans[,-c(1:4)]
}
plot_series = function(province="", country, dataset=sars2pack::mar19df, ...) {
 ser = get_series(province=province, country=country, dataset=dataset)
 dates = lubridate::as_date(mdy(names(dataset)[-c(1:4)]))
 plot(dates, ser, main=paste(province, country), ...)
}
par(mfrow=c(2,2),mar=c(4,3,2,2))
plot_series(province="Hubei", country="China")
plot_series(country="Italy")
plot_series(country="Thailand")
plot_series("Massachusetts", country="US")
```

# Using the [incidence] package

```{r incidenceconvert}
library(incidence)
as.incidence1 <- function(df) {
    ret =  df %>% dplyr::select(date,count) %>%
        dplyr::group_by(date) %>%
        dplyr::summarise(count = sum(count)) %>%
        dplyr::arrange(date)
    ret$count = c(diff(ret$count),0)
    return(structure(list(dates = ret$date, counts = matrix(ret$count,nc=1), interval  = 1L, timespan = nrow(ret), cumulative=FALSE, n=nrow(ret)), class='incidence'))
}

```


# Modeling illustrated for a simulation

Following code conveyed by John Mallery, we have the following
approach for estimating R0 using a single realization of
an epidemic simulation.

Note that there can be failures of `estimate.R` for certain
inputs.  We are working on that.
```{r dostraight}
library(R0)
# Generating an epidemic with given parameters
mGT <- generation.time("gamma", c(3,1.5))
set.seed(5432)  # always initialize when simulating!
mEpid <- sim.epid(epid.nb=1, GT=mGT, epid.length=30, 
     family="poisson", R0=1.67, peak.value=500)
mEpid <- mEpid[,1]
# Running estimations
est <- estimate.R(epid=mEpid, GT=mGT, methods=c("EG","ML","TD"), begin=1, end=30)
```

We modified the plotting function in `r CRANpkg("R0")` which
was calling `dev.new` too often.  Use `plot2`.

```{r lksim,fig.height=7}
par(mfrow=c(2,2))
plot2(est)
```

The plotfit2 function is also useful.  These fits
look identical but they are not.

```{r lksim2, fig.height=7}
par(mfrow=c(2,2))
plotfit2(est)
```

# Modeling for a geographic entity

Now we extract information from the time-series table and
obtain estimates of R0 under exponential growth.

## Hubei Province

We are able to use exponential growth and time-dependent models
with this data, using generation time model from a
recent [Annals of Internal Medicine](https://annals.org/aim/fullarticle/2762808/incubation-period-coronavirus-disease-2019-covid-19-from-publicly-reported) paper.

The incidence data probably need smoothing, and the time-dependent
model has unreasonable fluctuations.

```{r dohub,fig.height=7}
dates = lubridate::as_date(mdy(names(mar19df)[-c(1:4)]))
hubdat = as.numeric(get_series(province="Hubei", country="China", 
    dataset=sars2pack::mar19df))
names(hubdat) = dates
mGT <- generation.time("gamma", c(5.8, 0.95)) # from DOI 10.7326/M20-0504
hubdat.filt = trim_leading_values(c(hubdat[1], diff(hubdat)))
est.EG <- estimate.R(epid=hubdat.filt, GT=mGT, 
    methods=c("EG", "TD"), begin=1L, end=as.integer(length(hubdat.filt)))
est.EG
par(mfrow=c(2,2), mar=c(5,3,2,2))
plot2(est.EG)
plotfit2(est.EG)
```

## Italy

For Italy, only the EG model seems to work, with the
Annals of Internal Medicine generation time model.  It
fits the data reasonably well, but the data seems to include
a reporting gap.

```{r doit,fig.height=7}
itdat = as.numeric(get_series(province="", country="Italy", 
    dataset=sars2pack::mar19df))
names(itdat) = dates
itdat.filt = trim_leading_values(c(itdat[1], diff(itdat)))
est.EG <- estimate.R(epid=itdat.filt, GT=mGT, 
    methods=c("EG"), begin=1L, end=as.integer(length(itdat.filt)))
est.EG
par(mfrow=c(2,2), mar=c(5,3,2,2))
plot2(est.EG, main="Italy")
plotfit2(est.EG, main="Italy")
```


# Origins of this package

John C. Mallery conveyed code of Charles Morefield to harvest COVID-19
time series data.  Vince Carey then started an R package/github repo
to manage the relevant code.  The package was named `sars2pack` in
hopes of avoiding name conflict with many other packages while
remaining descriptive and focused.

